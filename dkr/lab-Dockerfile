FROM jupyter/datascience-notebook:latest

USER root

RUN export DEBIAN_FRONTEND=noninteractive && \
    apt-get update && \
    apt-get install --yes --no-install-recommends procps ca-certificates \
    git curl libpq-dev curl gnupg g++

USER ${NB_USER}

# TODO: tidy up the following to reduce layers; just added sequentially while working
RUN pip install  --no-cache-dir 'pystan' 'jupyterstan' && \
    fix-permissions "${CONDA_DIR}" && \
    fix-permissions "/home/${NB_USER}"

RUN pip install --upgrade cmdstanpy[all]

RUN R -e "install.packages(c('dplyr', 'lubridate', 'ggplot2', 'bayesplot', 'fs', 'stringr', 'remotes', 'data.table'), repos='https://cloud.r-project.org'))"
RUN R -e "remotes::install_github('stan-dev/posterior')"
RUN R -e "remotes::install_github('stan-dev/cmdstanr')"
RUN R -e "install.packages(c('RStan'), repos='https://cloud.r-project.org'))"

# RUN python -c "import cmdstanpy; cmdstanpy.install_cmdstan()"
RUN install_cmdstan

